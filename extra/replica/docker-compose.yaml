version: '3.8'

services:
  # Node 1 - FEDERATED mode
  node1:
    image: lordraw/open-secureconfiguration:latest
    container_name: opensecureconf-node1
    ports:
      - "9001:9000"
    environment:
      - OSC_HOST_PORT=9000
      - OSC_WORKERS=2
      - OSC_DATABASE_PATH=/app/data/configurations.db
      - OSC_SALT_FILE_PATH=/app/data/encryption.salt
      - OSC_MIN_USER_KEY_LENGTH=8
      - OSC_API_KEY_REQUIRED=true
      - OSC_API_KEY=cluster-secret-key-123
      # Cluster configuration
      - OSC_CLUSTER_ENABLED=true
      - OSC_CLUSTER_MODE=replica
      - OSC_CLUSTER_NODE_ID=node1:9000
      - OSC_CLUSTER_NODES=node2:9000,node3:9000
      - OSC_CLUSTER_SYNC_INTERVAL=30
      - OSC_LOG_LEVEL=DEBUG
      - OSC_LOG_FORMAT=console
      - prometheus_multiproc_dir=/app/prometheus_multiproc
    volumes:
      - ./data/node1:/app/data
    networks:
      - cluster_network
    restart: unless-stopped

  # Node 2 - FEDERATED mode
  node2:
    image: lordraw/open-secureconfiguration:latest
    container_name: opensecureconf-node2
    ports:
      - "9002:9000"
    environment:
      - OSC_HOST_PORT=9000
      - OSC_WORKERS=2
      - OSC_DATABASE_PATH=/app/data/configurations.db
      - OSC_SALT_FILE_PATH=/app/data/encryption.salt
      - OSC_MIN_USER_KEY_LENGTH=8
      - OSC_API_KEY_REQUIRED=true
      - OSC_API_KEY=cluster-secret-key-123
      # Cluster configuration
      - OSC_CLUSTER_ENABLED=true
      - OSC_CLUSTER_MODE=replica
      - OSC_CLUSTER_NODE_ID=node2:9000
      - OSC_CLUSTER_NODES=node1:9000,node3:9000
      - OSC_CLUSTER_SYNC_INTERVAL=30
      - OSC_LOG_LEVEL=DEBUG
      - OSC_LOG_FORMAT=console
      - prometheus_multiproc_dir=/app/prometheus_multiproc
    volumes:
      - ./data/node2:/app/data
    networks:
      - cluster_network
    restart: unless-stopped

  # Node 3 - FEDERATED mode
  node3:
    image: lordraw/open-secureconfiguration:latest
    container_name: opensecureconf-node3
    ports:
      - "9003:9000"
    environment:
      - OSC_HOST_PORT=9000
      - OSC_WORKERS=2
      - OSC_DATABASE_PATH=/app/data/configurations.db
      - OSC_SALT_FILE_PATH=/app/data/encryption.salt
      - OSC_MIN_USER_KEY_LENGTH=8
      - OSC_API_KEY_REQUIRED=true
      - OSC_API_KEY=cluster-secret-key-123
      # Cluster configuration
      - OSC_CLUSTER_ENABLED=true
      - OSC_CLUSTER_MODE=replica
      - OSC_CLUSTER_NODE_ID=node3:9000
      - OSC_CLUSTER_NODES=node1:9000,node2:9000
      - OSC_CLUSTER_SYNC_INTERVAL=30
      - OSC_LOG_LEVEL=DEBUG
      - OSC_LOG_FORMAT=console
      - prometheus_multiproc_dir=/app/prometheus_multiproc
    volumes:
      - ./data/node3:/app/data
    networks:
      - cluster_network
    restart: unless-stopped

networks:
  cluster_network:
    driver: bridge

