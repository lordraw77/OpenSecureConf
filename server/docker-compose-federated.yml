version: '3.8'

services:
  # Node 1 - FEDERATED mode
  node1:
    build: .
    container_name: opensecureconf-node1
    ports:
      - "9001:9000"
    environment:
      - HOST_PORT=9000
      - WORKERS=2
      - DATABASE_PATH=/app/data/configurations.db
      - SALT_FILE_PATH=/app/data/encryption.salt
      - MIN_USER_KEY_LENGTH=8
      - API_KEY_REQUIRED=true
      - API_KEY=cluster-secret-key-123
      # Cluster configuration
      - CLUSTER_ENABLED=true
      - CLUSTER_MODE=federated
      - CLUSTER_NODE_ID=node1:9000
      - CLUSTER_NODES=node2:9000,node3:9000
      - CLUSTER_SYNC_INTERVAL=30
    volumes:
      - ./data/node1:/app/data
    networks:
      - cluster_network
    restart: unless-stopped

  # Node 2 - FEDERATED mode
  node2:
    build: .
    container_name: opensecureconf-node2
    ports:
      - "9002:9000"
    environment:
      - HOST_PORT=9000
      - WORKERS=2
      - DATABASE_PATH=/app/data/configurations.db
      - SALT_FILE_PATH=/app/data/encryption.salt
      - MIN_USER_KEY_LENGTH=8
      - API_KEY_REQUIRED=true
      - API_KEY=cluster-secret-key-123
      # Cluster configuration
      - CLUSTER_ENABLED=true
      - CLUSTER_MODE=federated
      - CLUSTER_NODE_ID=node2:9000
      - CLUSTER_NODES=node1:9000,node3:9000
      - CLUSTER_SYNC_INTERVAL=30
    volumes:
      - ./data/node2:/app/data
    networks:
      - cluster_network
    restart: unless-stopped

  # Node 3 - FEDERATED mode
  node3:
    build: .
    container_name: opensecureconf-node3
    ports:
      - "9003:9000"
    environment:
      - HOST_PORT=9000
      - WORKERS=2
      - DATABASE_PATH=/app/data/configurations.db
      - SALT_FILE_PATH=/app/data/encryption.salt
      - MIN_USER_KEY_LENGTH=8
      - API_KEY_REQUIRED=true
      - API_KEY=cluster-secret-key-123
      # Cluster configuration
      - CLUSTER_ENABLED=true
      - CLUSTER_MODE=federated
      - CLUSTER_NODE_ID=node3:9000
      - CLUSTER_NODES=node1:9000,node2:9000
      - CLUSTER_SYNC_INTERVAL=30
    volumes:
      - ./data/node3:/app/data
    networks:
      - cluster_network
    restart: unless-stopped

networks:
  cluster_network:
    driver: bridge
